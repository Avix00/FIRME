<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ArTen - Registro Visitatori</title>
  <meta name="description" content="Sistema digitale per la registrazione degli ingressi visitatori - ArTen">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>

<body>

  <!-- ===================== HOME SCREEN ===================== -->
  <div id="screen-home" class="screen active">
    <div class="home-container">
      <div class="logo-section">
        <img src="image-Photoroom.png" alt="ArTen Logo" class="home-logo">
        <p class="subtitle">REGISTRO VISITATORI</p>
      </div>
      <div class="home-actions">
        <button class="btn btn-primary btn-xl" onclick="showScreen('screen-checkin')">
          <span class="btn-icon">‚û°Ô∏è</span>
          NUOVO INGRESSO
        </button>
        <button class="btn btn-secondary btn-xl" onclick="loadCheckout()">
          <span class="btn-icon">‚¨ÖÔ∏è</span>
          REGISTRA USCITA
        </button>
        <button class="btn btn-accent btn-xl" onclick="showScreen('screen-code-login')">
          <span class="btn-icon">üîë</span>
          ACCEDI CON CODICE
        </button>
        <button class="btn btn-qr btn-xl" onclick="showScreen('screen-qr-scanner')">
          <span class="btn-icon">üì∑</span>
          SCANSIONA QR
        </button>
      </div>
      <button class="btn-admin-link" onclick="showScreen('screen-admin-login')">
        ‚öôÔ∏è Area Admin
      </button>
      <div class="home-datetime" id="home-datetime"></div>
    </div>
  </div>

  <!-- ===================== CODE LOGIN SCREEN ===================== -->
  <div id="screen-code-login" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="showScreen('screen-home')">‚Üê Indietro</button>
      <h2>Accedi con Codice</h2>
      <img src="image-Photoroom.png" alt="ArTen" class="header-logo">
    </div>
    <div class="code-login-container">
      <div class="code-login-box">
        <span class="code-icon">üîë</span>
        <p>Inserisci il tuo codice personale</p>
        <div class="code-input-wrapper">
          <input type="text" id="code-input" placeholder="ARTEN-0000" maxlength="10" autocomplete="off"
            style="text-transform:uppercase; text-align:center; font-size:2rem; letter-spacing:4px; font-weight:700;">
        </div>
        <button class="btn btn-primary btn-lg" id="btn-code-login" onclick="submitCodeLogin()">
          ‚úÖ ACCEDI
        </button>
      </div>
    </div>
  </div>

  <!-- ===================== QR SCANNER SCREEN ===================== -->
  <div id="screen-qr-scanner" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="stopQRScanner(); showScreen('screen-home')">‚Üê Indietro</button>
      <h2>Scansiona QR Code</h2>
      <img src="image-Photoroom.png" alt="ArTen" class="header-logo">
    </div>
    <div class="qr-scanner-container">
      <div class="qr-video-wrapper">
        <video id="qr-video" autoplay playsinline></video>
        <div class="qr-viewfinder">
          <div class="qr-corner tl"></div>
          <div class="qr-corner tr"></div>
          <div class="qr-corner bl"></div>
          <div class="qr-corner br"></div>
          <div class="qr-scan-line"></div>
        </div>
      </div>
      <p class="qr-status" id="qr-status">Inquadra il QR code ricevuto via email</p>
    </div>
  </div>

  <!-- ===================== CHECK-IN SCREEN (Step 1: Form) ===================== -->
  <div id="screen-checkin" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="showScreen('screen-home')">‚Üê Indietro</button>
      <h2>Nuovo Ingresso</h2>
      <img src="image-Photoroom.png" alt="ArTen" class="header-logo">
    </div>
    <div class="form-container">
      <form id="checkin-form" onsubmit="return false;">
        <div class="form-grid">
          <div class="form-group">
            <label for="nominativo">Nome e Cognome *</label>
            <input type="text" id="nominativo" placeholder="Nome e Cognome" required autocomplete="off">
          </div>
          <div class="form-group">
            <label for="ditta">Ditta di provenienza *</label>
            <input type="text" id="ditta" placeholder="Nome azienda" required autocomplete="off">
          </div>
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" placeholder="email@esempio.com" required autocomplete="off">
          </div>
          <div class="form-group">
            <label for="referente">Referente interno *</label>
            <select id="referente" required>
              <option value="">-- Seleziona --</option>
              <!-- Populated dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label for="zona">Zona di accesso</label>
            <input type="text" id="zona" placeholder="Zona / reparto" autocomplete="off">
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-primary btn-lg" onclick="goToPrivacyStep()">
            AVANTI ‚û°Ô∏è
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===================== PRIVACY + SIGNATURE SCREEN (Step 2) ===================== -->
  <div id="screen-privacy" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="showScreen('screen-checkin')">‚Üê Indietro</button>
      <h2>Informativa Privacy e Firma</h2>
      <img src="image-Photoroom.png" alt="ArTen" class="header-logo">
    </div>
    <div class="privacy-document-container" id="privacy-scroll-container">
      <!-- PDF pages rendered here by pdf.js, signature canvas overlaid on last page -->
      <div id="pdf-pages-container"></div>
    </div>

    <div class="privacy-bottom-bar">
      <button type="button" class="btn btn-outline btn-sm" onclick="clearSignature()"
        style="margin-right:16px;">Cancella Firma</button>
      <button type="button" class="btn btn-primary btn-lg" id="btn-submit-checkin" onclick="submitCheckIn()">
        ‚úÖ CONFERMA E REGISTRA
      </button>
    </div>
  </div>

  <!-- ===================== SUCCESS SCREEN (with code) ===================== -->
  <div id="screen-success" class="screen">
    <div class="success-container">
      <div class="success-box">
        <span class="success-icon">‚úÖ</span>
        <h2>Ingresso Registrato!</h2>
        <p id="success-message"></p>
        <div class="code-display">
          <p style="color:#888;font-size:0.8rem;text-transform:uppercase;letter-spacing:2px;">Il tuo codice accesso</p>
          <p id="success-code" class="generated-code"></p>
          <p style="color:#666;font-size:0.85rem;">Conserva questo codice per accessi futuri</p>
        </div>
        <button class="btn btn-primary btn-lg" onclick="showScreen('screen-home')">CHIUDI</button>
      </div>
    </div>
  </div>

  <!-- ===================== CHECK-OUT SCREEN ===================== -->
  <div id="screen-checkout" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="showScreen('screen-home')">‚Üê Indietro</button>
      <h2>Registra Uscita</h2>
      <img src="image-Photoroom.png" alt="ArTen" class="header-logo">
    </div>
    <div class="checkout-container">
      <div class="checkout-search">
        <input type="text" id="checkout-search" placeholder="üîç Cerca per nome o codice..."
          oninput="filterCheckoutList()" autocomplete="off">
      </div>
      <div id="visitors-list" class="visitors-list">
        <!-- Populated dynamically -->
      </div>
      <div id="checkout-empty" class="empty-state" style="display:none;">
        <span class="empty-icon">üìã</span>
        <p>Nessun visitatore presente oggi.</p>
      </div>
      <div id="checkout-loading" class="loading-state">
        <div class="spinner"></div>
        <p>Caricamento...</p>
      </div>
    </div>
  </div>

  <!-- ===================== ADMIN LOGIN SCREEN ===================== -->
  <div id="screen-admin-login" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="showScreen('screen-home')">‚Üê Indietro</button>
      <h2>Area Admin</h2>
      <div class="spacer"></div>
    </div>
    <div class="admin-login-container">
      <div class="login-box">
        <span class="login-icon">üîí</span>
        <h3>Accesso riservato</h3>
        <div class="form-group">
          <label for="admin-password">Password</label>
          <input type="password" id="admin-password" placeholder="Inserisci la password" autocomplete="off">
        </div>
        <button class="btn btn-primary btn-lg" onclick="adminLogin()">ACCEDI</button>
        <p id="login-error" class="error-text" style="display:none;">Password errata.</p>
      </div>
    </div>
  </div>

  <!-- ===================== ADMIN DASHBOARD SCREEN ===================== -->
  <div id="screen-admin" class="screen">
    <div class="screen-header">
      <button class="btn-back" onclick="adminLogout()">‚Üê Esci</button>
      <h2>Dashboard Admin</h2>
      <img src="image-Photoroom.png" alt="ArTen" class="header-logo">
    </div>
    <div class="admin-container">
      <!-- TAB NAVIGATION -->
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchAdminTab('tab-stats')">üìä Statistiche</button>
        <button class="admin-tab" onclick="switchAdminTab('tab-visitors')">üìã Visitatori</button>
        <button class="admin-tab" onclick="switchAdminTab('tab-referees')">üë• Referenti</button>
      </div>

      <!-- TAB: STATISTICS -->
      <div id="tab-stats" class="admin-tab-content active">
        <div class="stats-grid">
          <div class="stat-card stat-entries">
            <span class="stat-icon">‚û°Ô∏è</span>
            <div class="stat-value" id="stat-entries">0</div>
            <div class="stat-label">Ingressi Oggi</div>
          </div>
          <div class="stat-card stat-exits">
            <span class="stat-icon">‚¨ÖÔ∏è</span>
            <div class="stat-value" id="stat-exits">0</div>
            <div class="stat-label">Uscite Oggi</div>
          </div>
          <div class="stat-card stat-present">
            <span class="stat-icon">üë•</span>
            <div class="stat-value" id="stat-present">0</div>
            <div class="stat-label">Presenti Ora</div>
          </div>
          <div class="stat-card stat-duration">
            <span class="stat-icon">‚è±Ô∏è</span>
            <div class="stat-value" id="stat-duration">‚Äî</div>
            <div class="stat-label">Durata Media</div>
          </div>
        </div>

        <div class="stats-section">
          <h3>üìà Flusso Orario</h3>
          <div class="chart-container" id="hourly-chart"></div>
        </div>

        <div class="stats-columns">
          <div class="stats-section">
            <h3>üèÜ Visitatori Frequenti</h3>
            <div id="top-visitors" class="stats-list"></div>
          </div>
          <div class="stats-section">
            <h3>üë§ Referenti pi√π Richiesti</h3>
            <div id="top-referees" class="stats-list"></div>
          </div>
        </div>
      </div>

      <!-- TAB: VISITORS -->
      <div id="tab-visitors" class="admin-tab-content">
        <div class="admin-toolbar">
          <div class="admin-date-picker">
            <label for="admin-date">Data:</label>
            <input type="date" id="admin-date" onchange="loadAdminData()">
            <button class="btn btn-outline btn-sm" onclick="setAdminDateToday()">Oggi</button>
          </div>
          <button class="btn btn-primary btn-sm" onclick="downloadExcel()">üì• Scarica Excel</button>
        </div>
        <div class="admin-table-wrapper">
          <table class="admin-table" id="admin-table">
            <thead>
              <tr>
                <th>Ora Entrata</th>
                <th>Ora Uscita</th>
                <th>Nominativo</th>
                <th>Ditta</th>
                <th>Email</th>
                <th>Referente</th>
                <th>Zona</th>
                <th>Codice</th>
                <th>Firma</th>
              </tr>
            </thead>
            <tbody id="admin-table-body">
            </tbody>
          </table>
          <div id="admin-empty" class="empty-state" style="display:none;">
            <span class="empty-icon">üìã</span>
            <p>Nessun ingresso registrato per questa data.</p>
          </div>
          <div id="admin-loading" class="loading-state" style="display:none;">
            <div class="spinner"></div>
            <p>Caricamento...</p>
          </div>
        </div>
      </div>

      <!-- TAB: REFEREES -->
      <div id="tab-referees" class="admin-tab-content">
        <div class="referees-section">
          <h3>Gestione Referenti Interni</h3>
          <div class="referee-add-form">
            <input type="text" id="new-referee-name" placeholder="Nome referente" autocomplete="off">
            <input type="email" id="new-referee-email" placeholder="Email (opzionale)" autocomplete="off">
            <button class="btn btn-primary btn-sm" onclick="addReferee()">‚ûï Aggiungi</button>
          </div>
          <div id="referees-list" class="referees-list">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== ERROR OVERLAY ===================== -->
  <div id="overlay-error" class="overlay" style="display:none;">
    <div class="overlay-content error">
      <span class="overlay-icon">‚ùå</span>
      <h2>Errore</h2>
      <p id="overlay-error-message"></p>
      <button class="btn btn-primary btn-lg" onclick="closeErrorOverlay()">OK</button>
    </div>
  </div>

  <!-- ===================== CHECKOUT CONFIRM DIALOG ===================== -->
  <div id="overlay-confirm" class="overlay" style="display:none;">
    <div class="overlay-content confirm">
      <span class="overlay-icon">‚¨ÖÔ∏è</span>
      <h2 id="confirm-title">Registra Uscita</h2>
      <p id="confirm-message"></p>
      <div class="confirm-actions">
        <button class="btn btn-secondary btn-lg" onclick="cancelConfirm()">ANNULLA</button>
        <button class="btn btn-primary btn-lg" id="btn-confirm-ok" onclick="okConfirm()">CONFERMA USCITA</button>
      </div>
    </div>
  </div>

  <!-- ===================== SCREENSAVER OVERLAY ===================== -->
  <div id="screensaver" class="screensaver" style="display:none;" onclick="wakeFromScreensaver()">
    <div class="screensaver-content">
      <img src="image-Photoroom.png" alt="ArTen" class="screensaver-logo">
      <div class="screensaver-clock" id="screensaver-clock">00:00</div>
      <div class="screensaver-date" id="screensaver-date"></div>
      <p class="screensaver-tap">Tocca per continuare</p>
    </div>
  </div>

  <script src="script.js"></script>
</body>

</html>